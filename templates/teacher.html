<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교사 페이지</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 900px;
        }
        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .student-list {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .student-list label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }
        #student-select {
            width: calc(100% - 12px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            margin-bottom: 10px;
        }
        #view-student-data {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        #view-student-data:hover {
            background-color: #1e7e34;
        }
        .student-counseling-data {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .counseling-entry {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #f9f9f9;
            border-radius: 4px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .counseling-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
            width: 100%;
        }
        .counseling-entry-content {
            /* white-space: pre-wrap; 제거 */
            margin-bottom: 10px;
            text-align: left;
            width: 100%;
        }
        .counseling-entry-content strong {
            display: block;
            margin-bottom: 5px;
        }
        .delete-button {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 0.8em;
            flex-shrink: 0;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
        .logout-button {
            background-color: #dc3545;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .logout-button:hover {
            background-color: #c82333;
        }
        .counseling-entry hr {
            width: 100%;
            border: none;
            border-top: 1px solid #eee;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/logout" class="logout-button">로그아웃</a>
        <h2>교사 페이지</h2>

        <div class="student-list">
            <label for="student-select">학생 선택:</label>
            <select id="student-select">
                <option value="">-- 학생을 선택하세요 --</option>
                {% for name in student_names %}
                <option value="{{ name }}">{{ name }}</option>
                {% endfor %}
            </select>
            <button id="view-student-data">학생 상담 내용 보기</button>
        </div>

        <div class="student-counseling-data">
            <h3>선택한 학생의 상담 내용</h3>
            <div id="counseling-data-container">
                <p>학생을 선택하여 상담 내용을 확인하세요.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const studentSelect = document.getElementById('student-select');
            const viewDataButton = document.getElementById('view-student-data');
            const dataContainer = document.getElementById('counseling-data-container');

            viewDataButton.addEventListener('click', function() {
                const selectedStudent = studentSelect.value;
                if (selectedStudent) {
                    fetch(`/get_student_data/${selectedStudent}`)
                        .then(response => response.json())
                        .then(data => {
                            dataContainer.innerHTML = ''; // 이전 데이터 지우기
                            if (data.length > 0) {
                                data.forEach((entry, index) => {
                                    const entryDiv = document.createElement('div');
                                    entryDiv.classList.add('counseling-entry');
                                    entryDiv.innerHTML = `
                                        <div class="counseling-entry-header">
                                            <strong>감정:</strong> ${entry.emotion ? entry.emotion : '중립'}
                                            <button class="delete-button">X</button>
                                        </div>
                                        <hr>
                                        <div class="counseling-entry-content">
                                            <strong>내용:</strong> ${entry.highlighted ? entry.highlighted : entry.content}
                                        </div>
                                    `;
                                    const deleteButton = entryDiv.querySelector('.delete-button');
                                    deleteButton.dataset.name = selectedStudent;
                                    deleteButton.dataset.index = index;
                                    dataContainer.appendChild(entryDiv);
                                });
                                attachDeleteEventListeners();
                            } else {
                                dataContainer.innerHTML = '<p>해당 학생의 상담 내용이 없습니다.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('학생 데이터 가져오기 오류:', error);
                            dataContainer.innerHTML = '<p>데이터를 불러오는 데 실패했습니다.</p>';
                        });
                } else {
                    dataContainer.innerHTML = '<p>학생을 선택해주세요.</p>';
                }
            });

            function attachDeleteEventListeners() {
                const deleteButtons = document.querySelectorAll('.delete-button');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const name = this.dataset.name;
                        const index = parseInt(this.dataset.index);

                        if (confirm('정말로 이 상담 내용을 삭제하시겠습니까?')) {
                            fetch(`/delete_entry/${name}/${index}`, {
                                method: 'DELETE'
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.message) {
                                    alert(data.message);
                                    viewDataButton.click(); // 목록 갱신
                                } else if (data.error) {
                                    alert(data.error);
                                }
                            })
                            .catch(error => {
                                console.error('상담 내용 삭제 오류:', error);
                                alert('상담 내용 삭제에 실패했습니다.');
                            });
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>